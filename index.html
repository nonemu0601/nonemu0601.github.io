<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIREシミュレーション</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 960px;
            margin: 20px auto;
            padding: 0 15px;
            background-color: #f9f9f9;
        }
        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }
        .container {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .form-container, .result-container {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .form-container {
            flex: 1;
            min-width: 300px;
        }
        .result-container {
            flex: 2;
            min-width: 400px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group .age-input {
            display: flex;
            gap: 10px;
        }
        .form-group .unit {
            display: inline-block;
            margin-left: 5px;
        }
        .calc-button {
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .calc-button:hover {
            background-color: #2980b9;
        }
        #summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #eaf5ff;
            border-left: 5px solid #3498db;
            font-size: 1.1em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        th {
            background-color: #f2f2f2;
            text-align: center;
        }
        .highlight {
            font-weight: bold;
            color: #e74c3c;
        }
    </style>
</head>
<body>

    <h1>FIREシミュレーション</h1>

    <div class="container">
        <div class="form-container">
            <h2>シミュレーション条件</h2>
            <div class="form-group">
                <label for="initial-asset">現在の資産</label>
                <input type="number" id="initial-asset" value="850"><span class="unit">万円</span>
            </div>
            <div class="form-group">
                <label>現在の年齢</label>
                <div class="age-input">
                    <input type="number" id="current-age-year" value="28"><span class="unit">歳</span>
                    <input type="number" id="current-age-month" value="0"><span class="unit">ヶ月</span>
                </div>
            </div>
            <hr>
            <div class="form-group">
                <label for="monthly-contribution-pre">退職までの毎月の積立額</label>
                <input type="number" id="monthly-contribution-pre" value="30"><span class="unit">万円</span>
            </div>
            <div class="form-group">
                <label>退職年齢</label>
                <div class="age-input">
                    <input type="number" id="retirement-age-year" value="40"><span class="unit">歳</span>
                    <input type="number" id="retirement-age-month" value="6"><span class="unit">ヶ月</span>
                </div>
            </div>
            <hr>
            <div class="form-group">
                <label for="post-retirement-duration">退職後の積立期間</label>
                <input type="number" id="post-retirement-duration" value="3"><span class="unit">年間</span>
            </div>
            <div class="form-group">
                <label for="monthly-contribution-post">上記期間の毎月の積立額</label>
                <input type="number" id="monthly-contribution-post" value="15"><span class="unit">万円</span>
            </div>
            <div class="form-group">
                <label for="living-cost">退職後の毎月の生活費</label>
                <input type="number" id="living-cost" value="25"><span class="unit">万円</span>
            </div>
            <hr>
            <div class="form-group">
                <label for="annual-interest-rate">資産の想定年利</label>
                <input type="number" id="annual-interest-rate" value="4"><span class="unit">%</span>
            </div>

            <button class="calc-button" onclick="runSimulation()">シミュレーション実行</button>
        </div>

        <div class="result-container">
            <h2>シミュレーション結果</h2>
            <canvas id="asset-chart"></canvas>
            <div id="summary"></div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table id="asset-table">
                    <thead>
                        <tr>
                            <th>年齢</th>
                            <th>資産額</th>
                            <th>年間増減額</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    let myChart;

    function runSimulation() {
        // --- フォームから値を取得 ---
        const initialAsset = parseFloat(document.getElementById('initial-asset').value) * 10000;
        const currentAgeYear = parseInt(document.getElementById('current-age-year').value);
        const currentAgeMonth = parseInt(document.getElementById('current-age-month').value);
        
        const contributionPre = parseFloat(document.getElementById('monthly-contribution-pre').value) * 10000;
        const retirementAgeYear = parseInt(document.getElementById('retirement-age-year').value);
        const retirementAgeMonth = parseInt(document.getElementById('retirement-age-month').value);

        const postRetirementDuration = parseInt(document.getElementById('post-retirement-duration').value);
        const contributionPost = parseFloat(document.getElementById('monthly-contribution-post').value) * 10000;
        const livingCost = parseFloat(document.getElementById('living-cost').value) * 10000;
        
        const annualRate = parseFloat(document.getElementById('annual-interest-rate').value) / 100;
        const monthlyRate = annualRate / 12;

        // --- 月単位に変換 ---
        const startMonth = currentAgeYear * 12 + currentAgeMonth;
        const retirementMonth = retirementAgeYear * 12 + retirementAgeMonth;
        const postContributionEndMonth = retirementMonth + postRetirementDuration * 12;

        // --- シミュレーション計算 ---
        let currentAsset = initialAsset;
        let history = [{ age: startMonth, asset: currentAsset }];
        let assetAtRetirement = 0;

        for (let month = startMonth; month < 100 * 12; month++) { // 100歳までシミュレーション
            const interest = currentAsset * monthlyRate;
            let monthlyChange = interest;

            if (month < retirementMonth) {
                // 退職前
                monthlyChange += contributionPre;
            } else {
                // 退職後
                if (month < postContributionEndMonth) {
                    monthlyChange += contributionPost;
                }
                monthlyChange -= livingCost;
            }
            
            currentAsset += monthlyChange;

            if (month === retirementMonth) {
                assetAtRetirement = currentAsset;
            }

            // 資産が0になったら終了
            if (currentAsset <= 0) {
                currentAsset = 0;
                history.push({ age: month + 1, asset: currentAsset });
                break;
            }
            
            history.push({ age: month + 1, asset: currentAsset });
        }

        // --- 結果の表示 ---
        displaySummary(assetAtRetirement, history, retirementAgeYear, retirementAgeMonth);
        displayTable(history, startMonth);
        displayChart(history, retirementMonth, startMonth);
    }

    function displaySummary(assetAtRetirement, history, retYear, retMonth) {
        const summaryDiv = document.getElementById('summary');
        const lastData = history[history.length - 1];
        let summaryText = `退職時 (${retYear}歳 ${retMonth}ヶ月) の資産額: <strong class="highlight">${(assetAtRetirement / 10000).toLocaleString('ja-JP', { maximumFractionDigits: 0 })} 万円</strong>`;

        if (lastData.asset <= 0) {
            const ageYear = Math.floor(lastData.age / 12);
            const ageMonth = lastData.age % 12;
            summaryText += `<br>資産が尽きる年齢: <strong class="highlight">${ageYear}歳 ${ageMonth}ヶ月</strong>`;
        } else {
            summaryText += `<br>100歳時点での資産額: <strong>${(lastData.asset / 10000).toLocaleString('ja-JP', { maximumFractionDigits: 0 })} 万円</strong>`;
        }
        summaryDiv.innerHTML = summaryText;
    }


    function displayTable(history, startMonth) {
        const tableBody = document.querySelector("#asset-table tbody");
        tableBody.innerHTML = "";
        
        let lastYearAsset = history[0].asset;

        history.forEach((data, index) => {
            const ageYear = Math.floor(data.age / 12);
            const ageMonth = data.age % 12;

            if (ageMonth === (startMonth % 12) && index > 0 || index === history.length - 1) {
                const row = tableBody.insertRow();
                const cellAge = row.insertCell(0);
                const cellAsset = row.insertCell(1);
                const cellChange = row.insertCell(2);
                
                cellAge.textContent = `${ageYear}歳 ${ageMonth}ヶ月`;
                cellAge.style.textAlign = 'center';

                cellAsset.textContent = `${(data.asset / 10000).toLocaleString('ja-JP', { maximumFractionDigits: 0 })} 万円`;
                
                const change = data.asset - lastYearAsset;
                cellChange.textContent = `${(change / 10000).toLocaleString('ja-JP', { maximumFractionDigits: 1, signDisplay: 'always' })} 万円`;
                
                lastYearAsset = data.asset;
            }
        });
    }

    function displayChart(history, retirementMonth, startMonth) {
        const ctx = document.getElementById('asset-chart').getContext('2d');
        
        const labels = history.filter(d => (d.age % 12 === startMonth % 12)).map(d => `${Math.floor(d.age / 12)}歳`);
        const data = history.filter(d => (d.age % 12 === startMonth % 12)).map(d => d.asset / 10000);

        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '資産推移 (万円)',
                    data: data,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: '資産額 (万円)'
                        },
                        ticks: {
                            callback: function(value, index, values) {
                                return value.toLocaleString('ja-JP');
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '年齢'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toLocaleString('ja-JP') + ' 万円';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // 初期表示
    document.addEventListener('DOMContentLoaded', runSimulation);

</script>

</body>
</html>